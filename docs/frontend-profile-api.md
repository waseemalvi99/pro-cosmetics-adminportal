# Backend API Changes: User Profile & Password Management

## Overview
New profile management endpoints and password reset flow have been added. The `UserDto` now includes a `ProfilePicture` field across all auth responses.

---

## Updated DTO: `UserDto`

All auth responses (`/api/auth/login`, `/api/auth/register`, `/api/auth/refresh-token`, `/api/profile`) now return:

```json
{
  "id": 1,
  "fullName": "John Doe",
  "email": "john@example.com",
  "isActive": true,
  "roles": ["Admin"],
  "permissions": ["Sales:Create", "Sales:View"],
  "createdAt": "2026-02-27T10:00:00Z",
  "profilePicture": "abc123.webp"
}
```

`profilePicture` is nullable. When present, the full image URL is: `/uploads/profiles/{profilePicture}` (relative to API base URL).

---

## New Endpoints

### 1. GET `/api/profile`
**Auth:** JWT required (any authenticated user)
**Description:** Get the current logged-in user's profile.

**Response:**
```json
{
  "success": true,
  "message": null,
  "data": { /* UserDto */ }
}
```

---

### 2. PUT `/api/profile`
**Auth:** JWT required
**Description:** Update the current user's display name.

**Request Body:**
```json
{
  "fullName": "New Name"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Profile updated successfully.",
  "data": { /* UserDto */ }
}
```

**Validation:** `fullName` must not be empty.

---

### 3. PUT `/api/profile/password`
**Auth:** JWT required
**Description:** Change the current user's password.

**Request Body:**
```json
{
  "currentPassword": "OldPass123",
  "newPassword": "NewPass456"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Password changed successfully.",
  "data": null
}
```

**Errors:**
- 400 if current password is wrong or new password doesn't meet policy (min 6 chars, uppercase, lowercase, digit).

---

### 4. POST `/api/profile/picture`
**Auth:** JWT required
**Content-Type:** `multipart/form-data`
**Description:** Upload a profile picture. Replaces any existing one.

**Request:** Form field `file` with an image (`.jpg`, `.jpeg`, `.png`, `.webp`). Image is auto-resized to 400x400 and converted to WebP.

**Response:**
```json
{
  "success": true,
  "message": "Profile picture uploaded successfully.",
  "data": "/uploads/profiles/a1b2c3d4.webp"
}
```

---

### 5. DELETE `/api/profile/picture`
**Auth:** JWT required
**Description:** Remove the current user's profile picture.

**Response:**
```json
{
  "success": true,
  "message": "Profile picture removed successfully.",
  "data": null
}
```

---

### 6. POST `/api/auth/forgot-password`
**Auth:** Anonymous (no JWT)
**Description:** Request a password reset code. An email with the reset token is sent to the user. Response is always success to avoid leaking whether the email exists.

**Request Body:**
```json
{
  "email": "user@example.com"
}
```

**Response (always):**
```json
{
  "success": true,
  "message": "If an account with that email exists, a password reset code has been sent.",
  "data": null
}
```

**Email sent to user contains:** A reset token string (long base64-encoded token generated by ASP.NET Identity).

---

### 7. POST `/api/auth/reset-password`
**Auth:** Anonymous (no JWT)
**Description:** Reset password using the token received via email.

**Request Body:**
```json
{
  "email": "user@example.com",
  "token": "CfDJ8N...long-token-from-email...",
  "newPassword": "NewSecurePass1"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Password has been reset successfully.",
  "data": null
}
```

**Errors:**
- 404 if email not found.
- 400 if token is invalid/expired or password doesn't meet policy.

---

## Welcome Email

When a new user is registered via `POST /api/auth/register`, a welcome email is automatically sent to the user's email address containing their login credentials (email + plaintext password) and a prompt to change their password. No frontend changes needed for this â€” it's fully backend-driven.

---

## Frontend Implementation Notes

### Profile Page
- Fetch profile on mount: `GET /api/profile`
- Edit name form: `PUT /api/profile` with `{ fullName }`
- Profile picture: display from `{API_BASE_URL}/uploads/profiles/{profilePicture}`, show default avatar if null
- Upload picture: `POST /api/profile/picture` as `multipart/form-data` with field name `file`
- Remove picture: `DELETE /api/profile/picture`
- Change password form: `PUT /api/profile/password` with `{ currentPassword, newPassword }` (add confirm password field on frontend)

### Forgot/Reset Password Flow
1. User clicks "Forgot Password?" on login page
2. Show form with email input -> `POST /api/auth/forgot-password`
3. Show success message regardless of response (always succeeds)
4. User checks email, gets a reset token
5. Show form with: email (pre-filled or editable), token (user pastes from email), new password, confirm password -> `POST /api/auth/reset-password`
6. On success, redirect to login page

### Password Policy (for frontend validation)
- Minimum 6 characters
- At least 1 uppercase letter
- At least 1 lowercase letter
- At least 1 digit
- Special characters not required

### Update Stored User Data
Since `UserDto` now includes `profilePicture`, update any local/state storage of user data (e.g. auth context, localStorage) to include this field. Display the profile picture in the navbar/header avatar.
